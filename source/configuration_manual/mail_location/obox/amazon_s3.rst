.. _amazon_s3:

=========
Amazon S3
=========

This document covers configuration specific to the Amazon Web Services S3
(Simple Storage Service). See also the base S3 configuration in
:ref:`s3_storages`.

.. code-block:: none

   fs_driver = aws-s3
   fs_s3_url = https://BUCKETNAME.s3.REGION.amazonaws.com/
   fs_s3_auth_role = s3access
   fs_s3_region = REGION

.. _fs-aws-s3:

AWS S3 Settings
---------------

See also :ref:`fs-http` and :ref:`fs-s3`.

.. dovecot_plugin:setting_filter:: fs_aws_s3
   :filter: fs_aws_s3
   :plugin: obox
   :values: @named_filter

   Filter for AWS S3-specific settings. :dovecot_plugin:ref:`fs_s3` filter is also used.


.. _aws_iam:

IAM authentication
------------------

.. dovecotadded:: 2.3.10

Dovecot supports AWS Identity and Access Management (IAM) for authenticating
requests to AWS S3 using the AWS EC2 Instance Metadata Service (IMDS), solely
version 2 of IMDS (IMDSv2) is supported.

Using IAM allows running Dovecot with S3 Storage while not keeping the
credentials in the configuration.

A requirement for using IMDSv2 is that Dovecot is running on an AWS EC2
instance, otherwise the IMDS will not be reachable. Additionally an IAM role
must be configured which allows trusted entities, EC2 in this case, to
assume that role. The role (for example ``s3access``) that will be assumed must
have the ``AmazonS3FullAccess`` policy attached.

The :dovecot_plugin:ref:`fs_s3_auth_role` setting specifies the IAM role to be assumed.
If no :dovecot_plugin:ref:`fs_s3_auth_role` is configured, no IAM lookup will be
done.

.. code-block:: none

   fs_driver = aws-s3
   fs_s3_url = https://bucket-name.s3.region.amazonaws.com/
   fs_s3_auth_role = s3access
   fs_s3_region = region

When using IAM you must ensure that the ``fs-auth`` service has proper
permissions/owner. Configure the user for the fs-auth listener to be the same
as for :dovecot_core:ref:`mail_uid`.

.. code-block:: none

   mail_uid = vmail
   service fs-auth {
     unix_listener fs-auth {
       user = vmail
     }
   }

For more information about IAM roles for EC2 please refer to:
`IAM roles for Amazon EC2 <https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html>`_

For general information about IAM:
`IAM UserGuide <https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html>`_


Manual authentication
---------------------

Get ACCESSKEY and SECRET from `www.aws.amazon.com <https://aws.amazon.com/>`_
-> My account -> Security credentials -> Access credentials. Create the
``BUCKETNAME`` from AWS Management Console -> S3 -> Create Bucket.

If the ``ACCESSKEY`` or ``SECRET`` contains any special characters, they can be
%hex-encoded.

.. Note::

  ``dovecot.conf`` handles %variable expansion internally as well, so % needs
  to be escaped as %% and ':' needs to be escaped as %%3A. For example if the
  SECRET is "foo:bar" this would be encoded as
  ``https://ACCESSKEY:foo%%3Abar:s3.example.com/``. This double-%% escaping is
  needed only when the string is read from ``dovecot.conf`` - it doesn't apply
  for example if the string comes from a userdb lookup.

Dispersion prefix
-----------------

.. code-block:: none

   mail_driver = obox
   mail_path = %8Mu/%u

As also explained in :ref:`s3_storages`, AWS can internally shard data much more
efficiently by including a dispersion prefix in all S3 paths. Without this the
S3 bucket may not scale above a certain limit in the number of S3
requests/second.

We recommend implementing the dispersion prefix by using the first 8 characters
of the hex representation of the MD5 hash of the username at the beginning of
each object path.

When a S3 bucket is created, AWS creates a single shared partition for the
bucket with a default limit of 3,500 requests/second for PUTs/DELETEs/POSTs
and 5500 requests/second for GETs (see
`Best Practices Design Patterns: Optimizing Amazon S3 Performance <https://docs.aws.amazon.com/AmazonS3/latest/dev/optimizing-performance.html>`_).

This 3,500 TPS limit is generally too small and quickly surpassed by Dovecot
which results in a spike of ``503: Slow Down`` log events. It is strongly
recommended to contact AWS to request they manually set up at least 1 layer of
hex partitioning (``0-9a-f``), to create 16 dedicated partitions for your
bucket. This "1 hex" layer of partitioning means a theoretical capacity of
56,000 PUTs/DELETEs/POSTs and 88,000 GETs per second.

Per AWS, you can go pretty deep in the number of layers, but most customers
do not need more than 2 layers of partitioning, (2 layers = 16x16 = 256
partitions = this would theoretically provide you up to ~896,000
PUT/DELETE/POST TPS and 1,408,000 GET TPS if requests are distributed evenly
across the partitions).

DNS
---

AWS instances are known to react badly when high packets per second network
traffic is generated by e.g. DNS lookups. Please see
:ref:`os_configuration_dns_lookups`.

AWS Signature version
---------------------

S3 driver uses the AWS signature version 2 method by default, but version 4
can be used by adding the region parameter to the S3 URL:

.. code-block:: none

  fs_driver = aws-s3
  fs_s3_url = https://ACCESSKEY:SECRET@BUCKETNAME.s3.eu-central-1.amazonaws.com/
  fs_s3_region = eu-central-1

aws-s3 backend
--------------

.. dovecotadded:: 2.3.10

Using the ``aws-s3`` backend is a simpler way to configure the S3 backend for
AWS. Currently it's the same as using the :ref:`fs-s3` backend with the
following default settings:

 * :dovecot_plugin:ref:`fs_http_add_headers`/``x-amz-security-token`` = ``%{auth:token}`` -
 * Enable using security token if returned by IAM lookup.
 * :dovecot_plugin:ref:`fs_http_log_headers`/``x-amz-request-id`` = yes and
   :dovecot_plugin:ref:`fs_http_log_headers`/``x-amz-id-2`` = yes - Include the these
   headers' values in all log messages related to the request. This additional
   information helps when Troubleshooting Amazon S3 See
   https://docs.aws.amazon.com/AmazonS3/latest/API/RESTCommonResponseHeaders.html

Example debug log message, which shows how the x-amz-\* headers are included:

.. code-block:: none

   Debug: http-client: conn 1.2.3.4:443 [1]: Got 200 response for request [Req1: GET https://test-mails.s3-service.com/?prefix=user%2Fidx%2F]: OK (x-amz-request-id:AABBCC22BB7798869, x-amz-id-2:DeadBeefanXBapRucWGAD1+aWwYMfwmXydlI0mHSuh4ic/j8Ji7gicTsP7xpMQz1IR9eydzeVI=) (took 63 ms + 140 ms in queue)

Example configuration
---------------------

With IAM:

.. code-block:: none

   mail_driver = obox
   mail_path = %8Mu/%u
   fs_s3_url = https://bucket-name.s3.region.amazonaws.com/
   fs_s3_region = region
   fs_s3_auth_role = s3access
   fs_compress_write_method = zstd
   obox {
     fs_driver = fscache
     fs_fscache_size = 512M
     fs_fscache_path = /var/cache/mails/%4Nu
     fs_parent {
       fs_driver = compress
       fs_parent {
         fs_driver = aws-s3
       }
     }
   }
   metacache {
     fs_driver = compress
     fs_parent {
       fs_driver = aws-s3
     }
   }
   fts_dovecot {
     fs_driver = fts-cache
     fs_s3_url = https://bucket-name.s3.region.amazonaws.com/%8Mu/%u/fts/
     fs_parent {
       fs_driver = fscache
       fs_fscache_size = 512M
       fs_fscache_path = /var/cache/fts/%4Nu
       fs_driver = compress
       fs_parent {
         fs_driver = aws-s3
       }
     }
   }
   mail_uid = vmail
   service fs-auth {
     unix_listener fs-auth {
       user = vmail
     }
   }

Without IAM add the ACCESSKEY and SECRET to the URL:

.. code-block:: none

   fs_s3_url = https://ACCESSKEY:SECRET@bucket-name.s3.region.amazonaws.com/
   fts_dovecot {
     fs_s3_url = https://ACCESSKEY:SECRET@bucket-name.s3.region.amazonaws.com/%8Mu/%u/fts/
   }
